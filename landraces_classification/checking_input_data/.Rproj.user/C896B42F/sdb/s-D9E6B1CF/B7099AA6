{
    "collab_server" : "",
    "contents" : "# Fisiotherapy analysis\n# H. Achicanoy\n# 2017\n\n# R options\noptions(warn = -1); options(scipen = 999)\n\n# Load packages\nsuppressMessages(library(tidyverse))\nsuppressMessages(library(modelr))\nsuppressMessages(library(dplyr))\nsuppressMessages(library(purrr))\nsuppressMessages(library(broom))\nsuppressMessages(library(tidyr))\nsuppressMessages(library(ggplot2))\nsuppressMessages(library(FactoMineR))\nsuppressMessages(library(factoextra))\nsuppressMessages(library(foreign))\nsuppressMessages(library(haven))\nsuppressMessages(library(corrplot))\nsuppressMessages(library(polycor))\nsuppressMessages(library(psych))\nsuppressMessages(library(gplots))\nsuppressMessages(library(viridis))\n\n# ----------------------------------------------------------------------------------- #\n# Read and pre-process data\n# ----------------------------------------------------------------------------------- #\ndf <- read.spss(file = \"./_data/cantera_data.sav\", to.data.frame = T)\ndf$MES_INGRESO <- df$FECHA_LESION <- df$FECHA_RETORNO_ENTRENO <- df$NOMBRE <- df$ANTIGUEDAD <- df$INCAPACIDAD <- df$APTITUD <- df$DIAGNOSTICO <- df$LUGAR_ATENCION <- df$MES_RETORNO <- NULL\ndf$GRAVEDAD <- factor(x = df$GRAVEDAD, levels = c(\"MENOR\", \"LEVE\", \"MODERADA\", \"GRAVE\"), ordered = T)\ndf$IMC_CUALI <- factor(x = df$IMC_CUALI, levels = c(\"BAJO PESO\", \"PESO NORMAL\", \"SOBREPESO\"), ordered = T)\ndf$CATEGORIA <- as.character(df$CATEGORIA); df$CATEGORIA <- as.factor(df$CATEGORIA)\ndf$MOMENTO_LESION <- as.character(df$MOMENTO_LESION); df$MOMENTO_LESION <- as.factor(df$MOMENTO_LESION)\ndf$AREA_CORPORAL <- as.character(df$AREA_CORPORAL); df$AREA_CORPORAL <- as.factor(df$AREA_CORPORAL)\ndf$TIPO_LESION <- as.character(df$TIPO_LESION); df$TIPO_LESION <- as.factor(df$TIPO_LESION)\ndf$TEJIDO_LESIONADO <- as.character(df$TEJIDO_LESIONADO); df$TEJIDO_LESIONADO <- as.factor(df$TEJIDO_LESIONADO)\ndf$MECANISMO <- as.character(df$MECANISMO); df$MECANISMO <- as.factor(df$MECANISMO)\n\nglimpse(df)\n\n# ----------------------------------------------------------------------------------- #\n# Calculate frequencies table\n# ----------------------------------------------------------------------------------- #\nfqTable <- df %>%\n  select(CATEGORIA, POSICION, LATERALIDAD, CIRUGIA, MOMENTO_LESION, AREA_CORPORAL, LADO, TIPO_LESION, TEJIDO_LESIONADO, MECANISMO, RECAIDA, GRAVEDAD) %>%\n  gather(measure, value) %>%\n  count(measure, value) %>%\n  spread(measure, n) %>%\n  gather(key = Variable, value = Count, AREA_CORPORAL:TIPO_LESION)\nfqTable <- fqTable[complete.cases(fqTable),]; rownames(fqTable) <- 1:nrow(fqTable); colnames(fqTable)[1] <- \"Category\"\nfqTable <- fqTable %>% dplyr::mutate(Percentage = Count/nrow(df))\n\n# Plot it (SAVE IT!!!!)\ngg <- fqTable %>% ggplot(aes(x = Category, y = Percentage*100)) +\n  geom_bar(stat = \"identity\") +\n  xlab(\"\") + ylab(\"Porcentaje (%)\") +\n  coord_flip() +\n  facet_wrap(~ Variable, scales = \"free\") +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12))\nggsave(\"./_results/qualitative_frequencies.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# ----------------------------------------------------------------------------------- #\n# Plotting cuantitative variables (SAVE IT!!!)\n# ----------------------------------------------------------------------------------- #\ngg <- df %>% select(EDAD, DIAS_INCAPACIDAD, TALLA, PESO, IMC, HORAS_JUEGO, HORAS_ENTRENAMIENTO) %>%\n  gather(Variable, Value) %>% ggplot(aes(x = Value, fill = Variable, alpha = .6)) +\n  geom_density() +\n  facet_wrap(~ Variable, scales = \"free\") +\n  theme_bw() +\n  theme(legend.position = \"bottom\") +\n  theme(legend.title = element_text(face = \"bold\")) +\n  guides(alpha = F, fill = F) +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12))\nggsave(\"./_results/quantitative_density.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(gg)\n\n# ----------------------------------------------------------------------------------- #\n# Summary measures\n# ----------------------------------------------------------------------------------- #\ndf %>% select(EDAD, DIAS_INCAPACIDAD, TALLA, PESO, IMC, HORAS_JUEGO, HORAS_ENTRENAMIENTO) %>%\n  psych::describe() %>% select(mean, sd, median, min, max, range) %>% write.csv(file = \"./_results/quantitative_summary.csv\", row.names = T)\n\n# ----------------------------------------------------------------------------------- #\n# Explore variable relationships\n# Chi-square test for cualitative data\n# ----------------------------------------------------------------------------------- #\ncatVar <- df %>%\n  select(CATEGORIA, POSICION, LATERALIDAD, CIRUGIA, MOMENTO_LESION, AREA_CORPORAL, LADO, TIPO_LESION, TEJIDO_LESIONADO, MECANISMO, RECAIDA, GRAVEDAD)\n\noptions(warn=-1)\np.chisq = matrix(0, nrow=ncol(catVar), ncol=ncol(catVar), byrow=T)\nfor(i in 1:ncol(catVar)){\n  for(j in 1:ncol(catVar)){\n    p.chisq[i,j] = round(chisq.test(catVar[,i],catVar[,j])$p.value,3)\n  }\n}; rm(i); rm(j)\n\ndiag(p.chisq) = NA\ncolnames(p.chisq) = colnames(catVar)\nrownames(p.chisq) = colnames(catVar)\n\ncolor_scale = colorRampPalette(c(\"tomato3\",\"lightyellow\",\"lightseagreen\"), space=\"rgb\")(50)\npng('./_results/chi_test.png', height = 7, width = 7, units = \"in\", res = 300)\nheatmap.2(p.chisq,\n          main=\"Independence test\",\n          key.title=\"Chi-square test\",\n          key.xlab=\"p-value\",\n          Rowv=NULL,\n          Colv=NULL,\n          col=color_scale,\n          linecol=NULL,\n          tracecol=NULL,\n          density.info=\"density\",\n          denscol=\"blue\",\n          margins=c(11,11))\ndev.off(); rm(catVar, p.chisq, color_scale)\n\n# ----------------------------------------------------------------------------------- #\n# Explore variable relationships\n# Spearman correlation for cuantitative data\n# ----------------------------------------------------------------------------------- #\n\npng('./_results/spearman_corr.png', height = 7, width = 7, units = \"in\", res = 300)\ndf %>% select(EDAD, DIAS_INCAPACIDAD, TALLA, PESO, IMC, HORAS_JUEGO, HORAS_ENTRENAMIENTO) %>%\n  cor(method = \"spearman\") %>% corrplot(method = \"ellipse\", type=\"upper\", is.corr = T, mar = c(0, 0, 3, 3))\ndev.off()\n\n# M <- hetcor(data = df)\n# corrplot(corr = M$correlations, type = \"upper\", is.corr = T)\n\n# ----------------------------------------------------------------------------------- #\n# Factor analysis for mixed data\n# ----------------------------------------------------------------------------------- #\nfamd.res <- FactoMineR::FAMD(base = df, graph = T)\nsummary(famd.res, nb.dec = 3, nbelements = 10,  ncp = TRUE)\n\n# ----------------------------------------------------------------------------------- #\n# Multiple correspondence analysis\n# ----------------------------------------------------------------------------------- #\n\nmca.res <- df %>%\n  select(CATEGORIA, POSICION, LATERALIDAD, CIRUGIA, MOMENTO_LESION, AREA_CORPORAL, LADO, TIPO_LESION, TEJIDO_LESIONADO, MECANISMO, RECAIDA, GRAVEDAD, EDAD, DIAS_INCAPACIDAD, TALLA, PESO, IMC, HORAS_JUEGO, HORAS_ENTRENAMIENTO) %>%\n  FactoMineR::MCA(quanti.sup = 13:19, graph = F)\n\n# Change No. 1\n# df$LATERALIDAD <- df$LADO <- df$MECANISMO <- NULL\n# mca.res <- FactoMineR::MCA(X = df, quanti.sup = c(1, 11, 13:15, 17:18), graph = F) # Originally c(1, 14, 16:18, 20:21)\n\n# Change No. 2\n# df$AREA_CORPORAL <- df$TEJIDO_LESIONADO <- df$CONTRATO <- NULL\n# mca.res <- FactoMineR::MCA(X = df, quanti.sup = c(1, 8, 10:12, 14:15), graph = F) # Originally c(1, 14, 16:18, 20:21)\n\n# Change No. 3\n# df2 <- df[,c(\"EDAD\", \"POSICION\", \"MOMENTO_LESION\", \"LADO\", \"MECANISMO\", \"RECAIDA\", \"TALLA\", \"PESO\", \"IMC\", \"HORAS_JUEGO\", \"HORAS_ENTRENAMIENTO\")]\n# mca.res <- FactoMineR::MCA(X = df2, quanti.sup = c(1, 7:11), graph = F)\n\nsummary(mca.res, nb.dec = 3, nbelements = 10,  ncp = TRUE)\n\n# Eigenvalues/variances\ngg <- fviz_screeplot(mca.res) + theme_bw()\nggsave(\"./_results/mca_eigenValues.png\", plot = gg, width = 7, height = 7, units = 'in'); rm(gg)\n\n# Coordinates of variable categories\ngg <- fviz_mca_var(mca.res, repel = TRUE) + theme_bw()\nggsave(\"./_results/mca_qualiVar_map.png\", plot = gg, width = 22, height = 10, units = 'in'); rm(gg)\n\n# Correlation circle for quantitative variables\npng('./_results/mca_quantiVar_map.png', height = 7, width = 7, units = \"in\", res = 300)\nplot(mca.res, choix = \"quanti.sup\")\ndev.off()\n\n# Plotting variables and individuals biplot\ngg <- fviz_mca_biplot(mca.res, repel = TRUE) + theme_bw()\nggsave(\"./_results/mca_biplot_map.png\", plot = gg, width = 22, height = 10, units = 'in'); rm(gg)\n\n\n# Contribution of variable categories to the dimensions\ncorrplot(mca.res$var$contrib, is.corr = FALSE)\n\n# The quality of representation of variable categories\ncorrplot(mca.res$var$cos2, is.corr=FALSE)\n\n# Just individuals\nfviz_mca_ind(mca.res) + theme_bw()\nfviz_mca_ind(mca.res, label = \"none\", habillage = df$CATEGORIA) + theme_bw()\nfviz_mca_ind(mca.res, label = \"none\", habillage = df$CATEGORIA, addEllipses = TRUE, ellipse.level = 0.95) + theme_bw()\n\n# Complex biplot\nfviz_mca_biplot(mca.res, \n                habillage = df$RECAIDA, addEllipses = F,\n                label = \"var\", shape.var = 15) +\n  scale_color_brewer(palette=\"Dark2\")+\n  theme_bw()\n\n# ----------------------------------------------------------------------------------- #\n# Position analysis\n# ----------------------------------------------------------------------------------- #\n\n# Heatmap Posicion vs Categoria\n\ngg <- df %>%\n  select(CATEGORIA, POSICION) %>%\n  table() %>% as.tibble() %>% ggplot(aes(x = CATEGORIA, y = POSICION, fill = 100 * n/nrow(df))) +\n  geom_tile(color = \"white\", size = 0.1) +\n  scale_fill_viridis(name = \"Porcentaje (%)\") +\n  coord_equal() +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/heatmap_posicion_categoria.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# Heatmap Posicion vs Momento de lesion\n\ngg <- df %>%\n  select(MOMENTO_LESION, POSICION) %>%\n  table() %>% as.tibble() %>% ggplot(aes(x = MOMENTO_LESION, y = POSICION, fill = 100 * n/nrow(df))) +\n  geom_tile(color = \"white\", size = 0.1) +\n  scale_fill_viridis(name = \"Porcentaje (%)\") +\n  coord_equal() +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/heatmap_posicion_momento_lesion.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# Heatmap Posicion vs Categoria/Momento de lesion per last variable\n\ngg <- df %>%\n  select(CATEGORIA, POSICION, MOMENTO_LESION) %>%\n  table() %>% as.tibble() %>% ggplot(aes(x = CATEGORIA, y = POSICION, fill = 100 * n/nrow(df))) +\n  geom_tile(color = \"white\", size = 0.1) +\n  scale_fill_viridis(name = \"Porcentaje (%)\") +\n  coord_equal() +\n  theme_bw() +\n  facet_wrap(~MOMENTO_LESION) +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text.x = element_text(size = 12, angle = 90),\n        axis.text.y = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/heatmap_posicion_categoria_momento_lesion.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# Heatmap Posicion vs Tipo de lesion\n\ngg <- df %>%\n  select(TIPO_LESION, POSICION) %>%\n  table() %>% as.tibble() %>% ggplot(aes(x = TIPO_LESION, y = POSICION, fill = 100 * n/nrow(df))) +\n  geom_tile(color = \"white\", size = 0.1) +\n  scale_fill_viridis(name = \"Porcentaje (%)\") +\n  coord_equal() +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text.x = element_text(size = 12, angle = 90),\n        axis.text.y = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/heatmap_posicion_tipo_lesion.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# Heatmap Posicion vs Area lesionada\n\ngg <- df %>%\n  select(AREA_CORPORAL, POSICION) %>%\n  table() %>% as.tibble() %>% ggplot(aes(x = AREA_CORPORAL, y = POSICION, fill = 100 * n/nrow(df))) +\n  geom_tile(color = \"white\", size = 0.1) +\n  scale_fill_viridis(name = \"Porcentaje (%)\") +\n  coord_equal() +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text.x = element_text(size = 12, angle = 90),\n        axis.text.y = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/heatmap_posicion_area_lesionada.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# Heatmap Posicion vs edad\n\ngg <- df %>% ggplot(aes(x = POSICION, y = EDAD, fill = POSICION)) +\n  geom_boxplot() +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/boxplot_posicion_edad.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# Heatmap Posicion vs tejido lesionado\n\ngg <- df %>%\n  select(TEJIDO_LESIONADO, POSICION) %>%\n  table() %>% as.tibble() %>% ggplot(aes(x = TEJIDO_LESIONADO, y = POSICION, fill = 100 * n/nrow(df))) +\n  geom_tile(color = \"white\", size = 0.1) +\n  scale_fill_viridis(name = \"Porcentaje (%)\") +\n  coord_equal() +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/heatmap_posicion_tejido_lesionado.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n\n# Heatmap Posicion vs dias de ausencia/mecanismo\n\ngg <- df %>% ggplot(aes(x = POSICION, y = DIAS_INCAPACIDAD, fill = POSICION)) +\n  geom_boxplot() +\n  facet_wrap(~MECANISMO) +\n  ylab(\"DIAS DE AUSENCIA\") +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12),\n        legend.title = element_text(size = 13, face = 'bold'),\n        legend.text = element_text(size = 12))\nggsave(\"./_results/boxplot_posicion_dias_ausencia_mecanismo.png\", plot = gg, width = 22, height = 10, units = \"in\"); rm(fqTable, gg)\n",
    "created" : 1502884844222.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3618554418",
    "id" : "B7099AA6",
    "lastKnownWriteTime" : 1497670015,
    "last_content_update" : 1497670015,
    "path" : "~/GitHub/Statistical_consulting/_fisiotherapy/_scripts/_analysis.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}
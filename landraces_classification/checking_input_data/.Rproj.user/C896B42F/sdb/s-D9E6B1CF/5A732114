{
    "collab_server" : "",
    "contents" : "# Genetic analysis\n# H. Achicanoy\n# CIAT, 2017\n\n# R options\noptions(warn = -1); options(scipen = 999); g <- gc(reset = T); rm(list = ls())\n\n# Load packages\nsuppressMessages(library(tidyverse))\nsuppressMessages(library(readxl))\nsuppressMessages(library(rgdal))\nsuppressMessages(library(sp))\nsuppressMessages(library(raster))\nsuppressMessages(library(ncdf4))\nsuppressMessages(library(rasterVis))\nsuppressMessages(library(htmlwidgets))\nsuppressMessages(library(compiler))\nsuppressMessages(library(leaflet))\nsuppressMessages(library(highcharter))\nsuppressMessages(library(plotly))\nsuppressMessages(library(d3heatmap))\nsuppressMessages(library(cluster))\nsuppressMessages(library(FactoMineR))\nsuppressMessages(library(factoextra))\nsuppressMessages(library(corrplot))\nsuppressMessages(library(Rtsne))\nsuppressMessages(library(randomForest))\n\n## =================================================================================================================== ##\n## Blair's study\n## =================================================================================================================== ##\n\nphenotypic_data <- read_excel(path = \"D:/ToBackup/climate_and_crop_modelling/cwr-landraces/Input_data/Blair_et_al_2009_races_subgroups_phenotypic.xlsx\", sheet = 2)\n\npar(mfrow = c(1,3))\nphenotypic_data %>% select(Meso.total, Andean.total) %>% cor(method = \"pearson\", use = \"complete.obs\") %>% corrplot.mixed()\nphenotypic_data %>% select(Meso.total, Andean.total) %>% cor(method = \"spearman\", use = \"complete.obs\") %>% corrplot.mixed()\nphenotypic_data %>% select(Meso.total, Andean.total) %>% cor(method = \"kendall\", use = \"complete.obs\") %>% corrplot.mixed()\n\npar(mfrow = c(1,3))\nphenotypic_data %>% select(D_J1, D_J2, G, M1, M2, NG1, NG2, P1, P2) %>% cor(method = \"pearson\", use = \"complete.obs\") %>% corrplot.mixed()\nphenotypic_data %>% select(D_J1, D_J2, G, M1, M2, NG1, NG2, P1, P2) %>% cor(method = \"spearman\", use = \"complete.obs\") %>% corrplot.mixed()\nphenotypic_data %>% select(D_J1, D_J2, G, M1, M2, NG1, NG2, P1, P2) %>% cor(method = \"kendall\", use = \"complete.obs\") %>% corrplot.mixed()\n# phenotypic_data %>% select(D_J1, D_J2, G, M1, M2, NG1, NG2, P1, P2) %>% cor(method = \"kendall\", use = \"complete.obs\") %>% corrplot(is.corr = T, method = \"ellipse\", type = \"upper\")\n\npar(mfrow = c(1,3))\nphenotypic_data %>% select(D_J.total, G, M.total, NG.total, P.total) %>% cor(method = \"pearson\", use = \"complete.obs\") %>% corrplot.mixed()\nphenotypic_data %>% select(D_J.total, G, M.total, NG.total, P.total) %>% cor(method = \"spearman\", use = \"complete.obs\") %>% corrplot.mixed()\nphenotypic_data %>% select(D_J.total, G, M.total, NG.total, P.total) %>% cor(method = \"kendall\", use = \"complete.obs\") %>% corrplot.mixed()\n\n## =================================================================================================================== ##\n## CIAT + USDA information with climate data\n## =================================================================================================================== ##\n\ngenotypic_climate <- read.csv(\"D:/ToBackup/climate_and_crop_modelling/cwr-landraces/Input_data/genotypic_climate.csv\")\ngenotypic_climate %>% glimpse\ngenotypic_climate_cmplt <- genotypic_climate[complete.cases(genotypic_climate),]\ngenotypic_climate_cmplt <- unique(genotypic_climate_cmplt); rownames(genotypic_climate_cmplt) <- 1:nrow(genotypic_climate_cmplt)\n\n# Descriptive analysis: quantitative variables\ngenotypic_climate_cmplt %>% dplyr::select(Elevation, Longitude, Latitude, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18) %>%\n  gather(Variable, Value) %>% ggplot(aes(x = Value, fill = Variable, alpha = .6)) +\n  geom_histogram() +\n  facet_wrap(~ Variable, scales = \"free\") +\n  theme_bw() +\n  theme(legend.position = \"bottom\") +\n  theme(legend.title = element_text(face = \"bold\")) +\n  guides(alpha = F, fill = F) +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12))\ngenotypic_climate_cmplt %>% dplyr::select(Elevation, Longitude, Latitude, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18) %>%\n  psych::describe() %>% select(mean, sd, median, min, max, range)\n\n# Descriptive analysis: qualitative variables\nfqTable <- genotypic_climate_cmplt %>% dplyr::select(Growth.habit, Seed.color, Seed.shape, Seed.brightness, Owner) %>%\n  gather(measure, value) %>%\n  count(measure, value) %>%\n  spread(measure, n) %>%\n  gather(key = Variable, value = Count, Growth.habit:Seed.shape)\nfqTable <- fqTable[complete.cases(fqTable),]; rownames(fqTable) <- 1:nrow(fqTable); colnames(fqTable)[1] <- \"Category\"\nfqTable <- fqTable %>% dplyr::mutate(Percentage = Count/nrow(genotypic_climate_cmplt))\n\nfqTable %>% ggplot(aes(x =  reorder(Category, Percentage), y = Percentage*100)) +\n  geom_bar(stat = \"identity\") +\n  xlab(\"\") + ylab(\"Percentage (%)\") +\n  coord_flip() +\n  facet_wrap(~ Variable, scales = \"free\") +\n  theme_bw() +\n  theme(strip.text = element_text(size = 12, face = \"bold\")) +\n  theme(axis.title.x = element_text(size = 13, face = 'bold'),\n        axis.title.y = element_text(size = 13, face = 'bold'),\n        axis.text = element_text(size = 12))\n\n# Identify multivariate outliers\n\n# Calculate Mahalanobis Distance with height and weight distributions\nm_dist <- mahalanobis(genotypic_climate_cmplt %>% dplyr::select(Elevation, Latitude, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18),\n                      colMeans(genotypic_climate_cmplt %>% dplyr::select(Elevation, Latitude, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18)),\n                      cov(genotypic_climate_cmplt %>% dplyr::select(Elevation, Latitude, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18)))\n\npca.res <- genotypic_climate_cmplt %>% dplyr::select(Elevation, Latitude, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18) %>%\n  FactoMineR::PCA(X = ., scale.unit = T, graph = T)\n\ntest <- data.frame(pca.res$ind$coord[,1:2], m_dist)\ntest %>% ggplot(aes(x = Dim.1, y = Dim.2, col = m_dist)) + geom_point()\ntest <- data.frame(genotypic_climate_cmplt[,c(\"Longitude\", \"Latitude\")], m_dist)\ntest %>% ggplot(aes(x = Longitude, y = Latitude, col = m_dist)) + geom_point()\n\nhighchart() %>% \n  hc_title(text = \"Scatter chart with number of coordinates and median harvested area by country\") %>% \n  hc_add_series_scatter(x = test$Longitude, y = test$Latitude, color = test$m_dist, label = genotypic_climate_cmplt$Owner)\n\n# Mahalanobis Outliers - Threshold set to 12\ndf$outlier_maha <- \"No\"\ndf$outlier_maha[df$m_dist > 12] <- \"Yes\"\n\n\n\n# Factor Analysis of Mixed Data\nset.seed(1)\nfamd_res <- FactoMineR::FAMD(base = genotypic_climate_cmplt[sample(x = 1:nrow(genotypic_climate_cmplt), size = 2000, replace = F),] %>% select(Elevation, Latitude, Growth.habit, Seed.color, Seed.shape, Seed.brightness, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18), graph = T)\nfviz_screeplot(famd_res) + theme_bw()\nfviz_famd_var(famd_res) + theme_bw()\nfviz_famd_var(famd_res, \"quanti.var\", repel = TRUE, col.var = \"black\") + theme_bw()\nfviz_famd_var(famd_res, \"quali.var\", col.var = \"black\")\nfviz_famd_ind(famd_res, col.ind = \"cos2\",\n              gradient.cols = c(\"#00AFBB\", \"#E7B800\", \"#FC4E07\"),\n              repel = TRUE)\n\n# Multiple Factor Analysis\nset.seed(1)\nmfa_res <- FactoMineR::MFA(base = genotypic_climate_cmplt[sample(x = 1:nrow(genotypic_climate_cmplt), size = 2000, replace = F),] %>% select(Elevation, Latitude, Growth.habit, Seed.color, Seed.shape, Seed.brightness, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18), group = c(2, 4, 9), type = c(\"s\", \"n\", \"s\"), graph = T)\n\n# Random forest clustering\nno.forests <- 25\nno.trees <- 3000\nset.seed(1)\ndistRF <- RFdist(datRF = genotypic_climate_cmplt[sample(x = 1:nrow(genotypic_climate_cmplt), size = 2000, replace = F),] %>% dplyr::select(Elevation, Latitude, Growth.habit, Seed.color, Seed.shape, Seed.brightness, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18) %>% unique(),\n                 mtry1 = 3, no.trees, no.forests, addcl1 = T, addcl2 = F, imp = T, oob.prox1 = T)\n\n### Clustering methods\n\n## Gower distance\n\nset.seed(1)\ngower.dist <- daisy(genotypic_climate_cmplt[sample(x = 1:nrow(genotypic_climate_cmplt), size = 2000, replace = F),] %>% dplyr::select(Elevation, Latitude, Growth.habit, Seed.color, Seed.shape, Seed.brightness, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18),\n                    metric = \"gower\", type = list(logratio = 3))\nsummary(gower.dist)\ngower.mat <- as.matrix(gower.dist)\n\nfviz_dist(as.dist(gower.mat),\n          gradient = list(low = \"#00AFBB\", mid = \"white\", high = \"#FC4E07\"))\n\nres.hc <- hclust(d = gower.dist, method = \"ward.D2\")\nfviz_dend(res.hc, cex = 0.5)\n\nfviz_dend(res.hc, k = 3, cex = 0.4, horiz = TRUE, k_colors = \"jco\",\n          rect = TRUE, rect_border = \"jco\", rect_fill = TRUE)\n\nlibrary(ClustOfVar)\nstability(tree = res.hc, B = 40, graph = T)\n\n\n\n\n\n\nfviz_nbclust(genotypic_climate_cmplt[sample(x = 1:nrow(genotypic_climate_cmplt), size = 2000, replace = F),] %>% dplyr::select(Elevation, Latitude, Growth.habit, Seed.color, Seed.shape, Seed.brightness, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18),\n             kmeans, method = \"gap_stat\") + geom_vline(xintercept = 4, linetype = 2) + \n  labs(subtitle = \"Elbow method\")\n\n\n# Fuzzy clustering\n\n# T-SNE\nLabels <- train$label\ntrain$label <- as.factor(train$label)\n## for plotting\ncolors = rainbow(length(unique(train$label)))\nnames(colors) = unique(train$label)\n\n## Executing the algorithm on curated data\nset.seed(1)\ntsne <- Rtsne(genotypic_climate_cmplt[sample(x = 1:nrow(genotypic_climate_cmplt), size = 2000, replace = F),] %>% select(Elevation, Latitude, Growth.habit, Seed.color, Seed.shape, Seed.brightness, Seed.weight, wc2.0_bio_30s_01:wc2.0_bio_30s_18) %>% unique(),\n              dims = 2, perplexity = 30, verbose = TRUE, max_iter = 500)\n\n## Plotting\nplot(tsne$Y, main = \"tsne\", pch = 20)\ntext(tsne$Y, labels=train$label, col=colors[train$label])\n\n\n# Stepwise Discriminant analysis\n\n\n# Canonical Discriminant analysis\n\n",
    "created" : 1499291327458.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "510290882",
    "id" : "5A732114",
    "lastKnownWriteTime" : 1502896847,
    "last_content_update" : 1502896847648,
    "path" : "D:/ToBackup/climate_and_crop_modelling/cwr-landraces/Scripts/checking_input_data/genetic_analysis.R",
    "project_path" : "genetic_analysis.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}